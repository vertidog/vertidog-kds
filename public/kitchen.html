<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>VertiDog KDS Pro</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        /* --- PROFESSIONAL DESIGN SYSTEM --- */
        :root {
            --bg-body: #121212;
            --bg-surface: #1e1e1e;
            --bg-surface-light: #2c2c2c;
            
            /* Status Colors (High Contrast) */
            --color-new: #3b82f6;       /* Bright Blue */
            --color-warn: #f59e0b;      /* Amber */
            --color-crit: #ef4444;      /* Red */
            --color-done: #22c55e;      /* Green */
            --color-text: #ffffff;
            --color-text-dim: #a1a1aa;
            
            /* Spacing */
            --gap: 12px;
            --radius: 8px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body {
            margin: 0;
            background: var(--bg-body);
            color: var(--color-text);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- HEADER --- */
        header {
            height: 60px;
            background: var(--bg-surface);
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            flex-shrink: 0;
        }
        .brand { font-weight: 800; letter-spacing: 1px; font-size: 1.2rem; }
        .clock { font-family: monospace; font-size: 1.2rem; color: var(--color-text-dim); }

        /* --- MAIN LAYOUT --- */
        .kds-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* ACTIVE LANE (Left) */
        .lane-active {
            flex: 1;
            padding: var(--gap);
            overflow-y: auto;
            display: grid;
            /* Adaptive Grid: Cards keep consistent width */
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            grid-auto-rows: max-content;
            gap: var(--gap);
            align-content: start;
            border-right: 1px solid #333;
            transition: background 0.2s;
        }

        /* COMPLETED SIDEBAR (Right) */
        .lane-completed {
            width: 260px;
            background: #181818;
            display: flex;
            flex-direction: column;
            border-left: 1px solid #000;
        }
        .sidebar-header {
            padding: 15px;
            font-size: 0.9rem;
            text-transform: uppercase;
            color: var(--color-text-dim);
            font-weight: 700;
            background: rgba(0,0,0,0.2);
        }
        .recalled-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        /* --- TICKET CARD DESIGN (Square Style) --- */
        .ticket {
            background: var(--bg-surface);
            border-radius: var(--radius);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
            border: 1px solid #333;
            transition: transform 0.1s, box-shadow 0.1s;
            position: relative;
        }
        .ticket:active { transform: scale(0.98); }
        
        /* Dragging States */
        .ticket.dragging { opacity: 0.5; border: 2px dashed #fff; }
        .lane-active.drag-over { background: rgba(59, 130, 246, 0.1); }
        .lane-completed.drag-over { background: rgba(34, 197, 94, 0.1); }

        /* TICKET HEADER */
        .ticket-header {
            padding: 10px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 700;
            color: #000; /* Contrast text for colored headers */
        }
        
        /* Dynamic Header Colors based on timer */
        .ticket[data-age="new"] .ticket-header { background: var(--color-new); color: white; }
        .ticket[data-age="warn"] .ticket-header { background: var(--color-warn); color: black; }
        .ticket[data-age="crit"] .ticket-header { background: var(--color-crit); color: white; }
        .ticket[data-age="done"] .ticket-header { background: var(--color-done); color: black; }
        .ticket[data-age="cancelled"] .ticket-header { background: #444; color: #aaa; text-decoration: line-through; }

        .ticket-id { font-size: 1.2rem; }
        .ticket-timer { font-family: monospace; font-size: 1.1rem; }

        /* TICKET BODY */
        .ticket-body {
            padding: 0 12px 12px 12px;
            flex: 1;
        }

        /* ITEM ROWS */
        .item-row {
            padding: 10px 0;
            border-bottom: 1px solid #333;
            cursor: pointer;
        }
        .item-row:last-child { border-bottom: none; }
        
        .item-header {
            display: flex;
            justify-content: space-between;
            font-size: 1.05rem;
            font-weight: 500;
        }
        .qty { color: var(--color-new); font-weight: 700; margin-right: 8px; }
        
        /* Item Bump State */
        .item-row.is-done { opacity: 0.3; text-decoration: line-through; }

        /* MODIFIERS */
        .modifiers {
            margin-top: 4px;
            padding-left: 24px;
            font-size: 0.9rem;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .mod { color: var(--color-text-dim); }
        .mod-no { color: var(--color-crit); font-weight: 600; } /* "No Cheese" */
        .mod-add { color: var(--color-done); font-weight: 600; } /* "Add Bacon" */

        /* FOOTER ACTIONS */
        .ticket-actions {
            display: flex;
            border-top: 1px solid #333;
        }
        .btn-action {
            flex: 1;
            padding: 12px;
            background: transparent;
            border: none;
            color: var(--color-text-dim);
            font-weight: 600;
            cursor: pointer;
            border-right: 1px solid #333;
        }
        .btn-action:last-child { border-right: none; }
        .btn-action:hover { background: #333; color: white; }
        .btn-bump { color: var(--color-done); }

        /* COMPLETED LIST ITEMS */
        .mini-ticket {
            background: var(--bg-surface-light);
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 8px;
            cursor: grab;
            border-left: 4px solid var(--color-done);
        }
        .mini-ticket .mini-header { font-weight: bold; display: flex; justify-content: space-between; }
        .mini-ticket.cancelled { border-left-color: var(--color-crit); opacity: 0.6; }

    </style>
</head>
<body>

<header>
    <div class="brand">VERTI-DOG KDS</div>
    <div class="clock" id="system-clock">00:00</div>
</header>

<div class="kds-container">
    
    <div id="active-lane" class="lane-active" 
         ondragover="allowDrop(event)" 
         ondragleave="removeHighlight(event)" 
         ondrop="dropRecall(event)">
        </div>

    <div class="lane-completed" 
         ondragover="allowDrop(event)" 
         ondragleave="removeHighlight(event)" 
         ondrop="dropComplete(event)">
        <div class="sidebar-header">Recently Completed</div>
        <div id="completed-list" class="recalled-list">
            </div>
    </div>

</div>

<script>
    // --- CONFIGURATION ---
    const WS_URL = `ws://${window.location.host}`;
    const WARN_TIME_SEC = 180; // 3 mins -> Yellow
    const CRIT_TIME_SEC = 360; // 6 mins -> Red

    let socket;
    let orders = {};

    // --- UTILS ---
    function formatTime(ms) {
        const totalSec = Math.floor(ms / 1000);
        const m = Math.floor(totalSec / 60).toString().padStart(2,'0');
        const s = (totalSec % 60).toString().padStart(2,'0');
        return `${m}:${s}`;
    }

    function getAgeCategory(createdAt) {
        const ageSec = (Date.now() - createdAt) / 1000;
        if (ageSec > CRIT_TIME_SEC) return 'crit';
        if (ageSec > WARN_TIME_SEC) return 'warn';
        return 'new';
    }

    // --- RENDER LOGIC ---

    function renderOrders() {
        const activeLane = document.getElementById('active-lane');
        const completedList = document.getElementById('completed-list');
        
        activeLane.innerHTML = '';
        completedList.innerHTML = '';

        // Sort orders: Active first, then by time
        const sortedOrders = Object.values(orders).sort((a,b) => a.createdAt - b.createdAt);

        sortedOrders.forEach(order => {
            if (order.status === 'done' || order.status === 'cancelled') {
                renderCompletedItem(order, completedList);
            } else {
                renderActiveTicket(order, activeLane);
            }
        });
    }

    function renderActiveTicket(order, container) {
        const ageCat = getAgeCategory(order.createdAt);
        const el = document.createElement('div');
        el.className = 'ticket';
        el.setAttribute('draggable', 'true');
        el.dataset.id = order.id;
        el.dataset.age = ageCat;

        // Drag Start
        el.addEventListener('dragstart', (e) => {
            e.dataTransfer.setData('text/plain', order.id);
            el.classList.add('dragging');
        });
        el.addEventListener('dragend', () => el.classList.remove('dragging'));

        // HTML Content
        el.innerHTML = `
            <div class="ticket-header">
                <span class="ticket-id">#${order.displayId}</span>
                <span class="ticket-timer">${formatTime(Date.now() - order.createdAt)}</span>
            </div>
            <div class="ticket-body">
                ${order.items.map(item => renderItemRow(order.id, item)).join('')}
            </div>
            <div class="ticket-actions">
                <button class="btn-action" onclick="sendCommand('SET_STATUS', '${order.id}', null, {status: 'cancelled'})">VOID</button>
                <button class="btn-action btn-bump" onclick="sendCommand('SET_STATUS', '${order.id}', null, {status: 'done'})">DONE</button>
            </div>
        `;
        container.appendChild(el);
    }

    function renderItemRow(orderId, item) {
        const isDone = item.status === 'done' ? 'is-done' : '';
        
        // Modifier Logic (Coloring)
        const modsHtml = item.modifiers.map(m => {
            let modClass = 'mod';
            if (m.toLowerCase().includes('no ') || m.toLowerCase().includes('hold ')) modClass = 'mod-no';
            if (m.toLowerCase().includes('add ') || m.toLowerCase().includes('extra ')) modClass = 'mod-add';
            return `<div class="${modClass}">+ ${m}</div>`;
        }).join('');

        // Note: onclick calls toggleItem
        return `
            <div class="item-row ${isDone}" onclick="sendCommand('TOGGLE_ITEM', '${orderId}', '${item.id}')">
                <div class="item-header">
                    <span><span class="qty">${item.quantity}</span> ${item.name}</span>
                </div>
                <div class="modifiers">${modsHtml}</div>
            </div>
        `;
    }

    function renderCompletedItem(order, container) {
        const el = document.createElement('div');
        el.className = `mini-ticket ${order.status}`;
        el.setAttribute('draggable', 'true');
        el.dataset.id = order.id;

        el.addEventListener('dragstart', (e) => {
            e.dataTransfer.setData('text/plain', order.id);
        });

        const timeStr = order.completedAt ? new Date(order.completedAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '--:--';

        el.innerHTML = `
            <div class="mini-header">
                <span>#${order.displayId}</span>
                <span>${timeStr}</span>
            </div>
            <div style="font-size:0.8rem; margin-top:4px;">${order.itemCount} items</div>
        `;
        // Prepend so newest is at top
        container.prepend(el);
    }

    // --- DRAG AND DROP HANDLERS ---

    window.allowDrop = (e) => {
        e.preventDefault();
        e.currentTarget.classList.add('drag-over');
    };

    window.removeHighlight = (e) => {
        e.currentTarget.classList.remove('drag-over');
    };

    window.dropComplete = (e) => {
        e.preventDefault();
        e.currentTarget.classList.remove('drag-over');
        const id = e.dataTransfer.getData('text/plain');
        if (orders[id]) sendCommand('SET_STATUS', id, null, {status: 'done'});
    };

    window.dropRecall = (e) => {
        e.preventDefault();
        e.currentTarget.classList.remove('drag-over');
        const id = e.dataTransfer.getData('text/plain');
        if (orders[id]) sendCommand('SET_STATUS', id, null, {status: 'in-progress'});
    };

    // --- WEBSOCKET & LOGIC ---

    function sendCommand(action, orderId, itemId = null, payload = {}) {
        if (socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify({ action, orderId, itemId, payload }));
        }
    }

    function initSocket() {
        socket = new WebSocket(WS_URL);
        
        socket.onmessage = (e) => {
            const data = JSON.parse(e.data);
            if (data.type === 'SYNC') {
                orders = data.orders;
                renderOrders();
            } else if (data.type === 'ORDER_UPDATE') {
                orders[data.order.id] = data.order;
                
                // Audio Alert (TTS) for new orders
                if(data.order.status === 'new' && (Date.now() - data.order.createdAt) < 5000) {
                    announceNewOrder(data.order.displayId);
                }
                renderOrders();
            }
        };

        socket.onclose = () => setTimeout(initSocket, 3000); // Auto reconnect
    }

    // --- AUDIO (TTS) ---
    function announceNewOrder(id) {
        if ('speechSynthesis' in window) {
            const u = new SpeechSynthesisUtterance(`New order ${id}`);
            window.speechSynthesis.speak(u);
        }
    }

    // --- CLOCK & TICKER ---
    setInterval(() => {
        // Update header clock
        const now = new Date();
        document.getElementById('system-clock').innerText = now.toLocaleTimeString();
        
        // Update timers on cards (simple DOM update to avoid full re-render)
        document.querySelectorAll('.ticket').forEach(el => {
            const id = el.dataset.id;
            if(orders[id]) {
                const ageCat = getAgeCategory(orders[id].createdAt);
                if (el.dataset.age !== ageCat) {
                    renderOrders(); // Re-render if color needs to change
                } else {
                    el.querySelector('.ticket-timer').innerText = formatTime(Date.now() - orders[id].createdAt);
                }
            }
        });
    }, 1000);

    initSocket();

</script>
</body>
</html>
