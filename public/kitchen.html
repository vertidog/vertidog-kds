<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>VertiDog Kitchen Screen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #050816;
      --card-bg: #0b1020;
      --new: #3b82f6;
      --progress: #f97316;
      --ready: #22c55e;
      --text: #e5e7eb;
      --muted: #6b7280;
      --accent: #a855f7;
      --border-subtle: rgba(148, 163, 184, 0.35);
    }
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: radial-gradient(circle at top, #111827 0, #020617 55%, #000 100%);
      color: var(--text);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    header {
      padding: 0.75rem 1.25rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(15, 23, 42, 0.95);
      border-bottom: 1px solid rgba(148, 163, 184, 0.3);
      backdrop-filter: blur(10px);
      z-index: 10;
    }
    header .left {
      display: flex;
      align-items: baseline;
      gap: 0.75rem;
    }
    header h1 {
      font-size: 1.1rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      margin: 0;
      color: var(--accent);
    }
    header .subtitle {
      font-size: 0.8rem;
      color: var(--muted);
      max-width: 260px;
    }
    header .status-pill {
      padding: 0.25rem 0.75rem;
      border-radius: 999px;
      font-size: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.4rem;
      background: rgba(34, 197, 94, 0.12);
      border: 1px solid rgba(34, 197, 94, 0.3);
      color: #bbf7d0;
    }
    header .status-pill.disconnected {
      background: rgba(249, 115, 22, 0.15);
      border-color: rgba(249, 115, 22, 0.7);
      color: #fed7aa;
    }
    header .dot {
      width: 0.4rem;
      height: 0.4rem;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 8px rgba(34, 197, 94, 0.8);
    }
    header .status-pill.disconnected .dot {
      background: #f97316;
      box-shadow: 0 0 8px rgba(249, 115, 22, 0.9);
    }

    main {
      flex: 1;
      display: grid;
      grid-template-columns: minmax(0, 2.3fr) minmax(260px, 1fr);
      gap: 0.75rem;
      padding: 0.75rem;
      overflow: hidden;
    }

    /* Left: bubbles */
    #bubble-container {
      position: relative;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 0.8rem;
      align-content: flex-start;
      padding-right: 0.4rem;
      overflow: auto;
    }
    #bubble-container::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    #bubble-container::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.25);
      border-radius: 999px;
    }

    .bubble {
      position: relative;
      width: 100%;
      aspect-ratio: 1/1;
      border-radius: 999px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border: 2px solid transparent;
      box-shadow:
        0 14px 35px rgba(0, 0, 0, 0.7),
        0 0 24px rgba(59, 130, 246, 0.22);
      transition:
        transform 0.08s ease-out,
        box-shadow 0.2s ease-out,
        background 0.2s ease-out,
        border-color 0.2s ease-out,
        opacity 0.3s ease-out;
      user-select: none;
      touch-action: manipulation;
      padding: 0.3rem;
      text-align: center;
    }
    .bubble:active {
      transform: scale(0.96);
    }
    .bubble.selected {
      box-shadow:
        0 0 0 3px rgba(168, 85, 247, 0.7),
        0 15px 40px rgba(0, 0, 0, 0.9);
    }
    .bubble-number {
      font-size: 1.75rem;
      font-weight: 800;
      letter-spacing: 0.06em;
    }
    .bubble-meta {
      margin-top: 0.1rem;
      font-size: 0.75rem;
      color: var(--muted);
    }
    .bubble-status {
      position: absolute;
      bottom: 0.35rem;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.65rem;
      padding: 0.1rem 0.5rem;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.92);
      border: 1px solid rgba(148, 163, 184, 0.4);
      color: rgba(209, 213, 219, 0.96);
    }
    .bubble.new {
      background: radial-gradient(circle at 30% 0%, rgba(59, 130, 246, 0.75), rgba(15, 23, 42, 0.97));
      border-color: rgba(59, 130, 246, 0.85);
    }
    .bubble.in-progress {
      background: radial-gradient(circle at 30% 0%, rgba(249, 115, 22, 0.8), rgba(15, 23, 42, 0.97));
      border-color: rgba(249, 115, 22, 0.9);
    }
    .bubble.ready {
      background: radial-gradient(circle at 30% 0%, rgba(34, 197, 94, 0.8), rgba(15, 23, 42, 0.97));
      border-color: rgba(34, 197, 94, 0.9);
    }

    .empty-state {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
      color: var(--muted);
      pointer-events: none;
    }

    /* Right: detail panel */
    #detail-panel {
      background: radial-gradient(circle at top left, rgba(15,23,42,0.95) 0, #020617 55%, #000 100%);
      border-radius: 1rem;
      border: 1px solid rgba(148, 163, 184, 0.3);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.7);
      display: flex;
      flex-direction: column;
      padding: 0.9rem 1rem;
      overflow: hidden;
      min-height: 0;
    }
    #detail-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 0.5rem;
      margin-bottom: 0.4rem;
    }
    .detail-title {
      font-size: 1rem;
      font-weight: 600;
    }
    .detail-status {
      font-size: 0.75rem;
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }
    .detail-status.new {
      border-color: rgba(59, 130, 246, 0.8);
      color: #bfdbfe;
    }
    .detail-status.in-progress {
      border-color: rgba(249, 115, 22, 0.9);
      color: #fed7aa;
    }
    .detail-status.ready {
      border-color: rgba(34, 197, 94, 0.9);
      color: #bbf7d0;
    }
    .detail-meta {
      font-size: 0.75rem;
      color: var(--muted);
      margin-bottom: 0.5rem;
    }
    .detail-meta span + span::before {
      content: "•";
      margin: 0 0.35rem;
      color: rgba(148, 163, 184, 0.6);
    }

    .items-header {
      font-size: 0.75rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--muted);
      margin: 0.3rem 0 0.15rem;
    }
    #items-list {
      flex: 1;
      overflow: auto;
      padding-right: 0.2rem;
      padding-bottom: 0.25rem;
      margin-bottom: 0.4rem;
    }
    #items-list::-webkit-scrollbar {
      width: 5px;
    }
    #items-list::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.25);
      border-radius: 999px;
    }

    .item-row {
      padding: 0.35rem 0.4rem;
      border-radius: 0.45rem;
      background: rgba(15, 23, 42, 0.85);
      border: 1px solid rgba(31, 41, 55, 0.9);
      margin-bottom: 0.25rem;
    }
    .item-main {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 0.5rem;
    }
    .item-name {
      font-size: 0.85rem;
      font-weight: 500;
    }
    .item-qty {
      font-size: 0.75rem;
      color: var(--muted);
    }
    .item-modifiers {
      margin-top: 0.15rem;
      font-size: 0.75rem;
      color: rgba(156, 163, 175, 0.95);
    }

    /* Recently completed footer */
    #footer {
      padding: 0.35rem 0.85rem 0.55rem;
      border-top: 1px solid rgba(15, 23, 42, 0.9);
      margin-top: 0.1rem;
    }
    #recent-title {
      font-size: 0.7rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.14em;
      margin-bottom: 0.15rem;
    }
    #recent-container {
      display: flex;
      gap: 0.4rem;
      overflow-x: auto;
      padding-bottom: 0.2rem;
    }
    #recent-container::-webkit-scrollbar {
      height: 5px;
    }
    #recent-container::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.25);
      border-radius: 999px;
    }
    .recent-pill {
      min-width: 52px;
      padding: 0.18rem 0.4rem;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: radial-gradient(circle at 30% 0%, rgba(31, 41, 55, 1), rgba(15, 23, 42, 0.98));
      font-size: 0.7rem;
      text-align: center;
      color: rgba(209, 213, 219, 0.9);
      white-space: nowrap;
    }

    @media (max-width: 900px) {
      main {
        grid-template-columns: minmax(0, 1.8fr) minmax(230px, 1fr);
      }
    }
    @media (max-width: 720px) {
      main {
        grid-template-columns: 1fr;
        grid-template-rows: minmax(0, 1.4fr) minmax(0, 1fr);
      }
      #detail-panel {
        min-height: 180px;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="left">
      <h1>VERTIDOG KITCHEN</h1>
      <div class="subtitle">
        Tap bubbles to advance: NEW → IN PROGRESS → READY. Ready orders chime + voice.
      </div>
    </div>
    <div class="status-pill" id="connection-status">
      <span class="dot"></span>
      <span>Connected</span>
    </div>
  </header>

  <main>
    <section id="bubble-container">
      <div class="empty-state" id="empty-state">No active orders</div>
    </section>

    <aside id="detail-panel">
      <div id="detail-header">
        <div class="detail-title" id="detail-title">No order selected</div>
        <div class="detail-status" id="detail-status">--</div>
      </div>
      <div class="detail-meta" id="detail-meta">
        <span>Items: 0</span>
        <span>Waiting...</span>
      </div>

      <div class="items-header">Items</div>
      <div id="items-list">
        <div style="font-size:0.8rem;color:var(--muted);margin-top:0.4rem;">
          Tap an order bubble to see details here.
        </div>
      </div>

      <div id="footer">
        <div id="recent-title">Recently completed</div>
        <div id="recent-container"></div>
      </div>
    </aside>
  </main>

  <!-- Chime sound -->
  <audio id="ready-sound" preload="auto">
    <source src="/sounds/order-ready.mp3" type="audio/mpeg" />
  </audio>

  <script>
    const WS_URL =
      (location.protocol === "https:" ? "wss://" : "ws://") +
      location.host +
      "/ws";

    const bubbleContainer = document.getElementById("bubble-container");
    const emptyState = document.getElementById("empty-state");
    const connectionStatus = document.getElementById("connection-status");
    const detailTitle = document.getElementById("detail-title");
    const detailStatus = document.getElementById("detail-status");
    const detailMeta = document.getElementById("detail-meta");
    const itemsList = document.getElementById("items-list");
    const recentContainer = document.getElementById("recent-container");
    const readySound = document.getElementById("ready-sound");

    const orders = {};          // active orders: { orderId: {...} }
    const recentCompleted = []; // array of { orderNumber }
    let selectedOrderId = null;
    let socket;

    // ---------- TTS QUEUE (chime then voice, one at a time) ----------
    const ttsQueue = [];
    let ttsActive = false;

    function enqueueAnnouncement(orderNumber) {
      const line = `Order ${orderNumber} is ready for pickup.`;
      ttsQueue.push(line);
      processTTSQueue();
    }

    function processTTSQueue() {
      if (ttsActive) return;
      if (!("speechSynthesis" in window)) return;
      if (!ttsQueue.length) return;

      const text = ttsQueue.shift();
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.rate = 1.0;
      utterance.pitch = 1.0;
      utterance.volume = 1.0;

      ttsActive = true;
      utterance.onend = () => {
        ttsActive = false;
        if (ttsQueue.length) {
          processTTSQueue();
        }
      };

      // chime already played in cycleStatus; just speak here
      window.speechSynthesis.speak(utterance);
    }

    // ---------- WebSocket handling ----------

    function setConnectionState(connected) {
      const dot = connectionStatus.querySelector(".dot");
      const label = connectionStatus.querySelector("span:last-child");
      if (connected) {
        connectionStatus.classList.remove("disconnected");
        dot.style.background = "#22c55e";
        label.textContent = "Connected";
      } else {
        connectionStatus.classList.add("disconnected");
        dot.style.background = "#f97316";
        label.textContent = "Reconnecting…";
      }
    }

    function connect() {
      setConnectionState(false);
      socket = new WebSocket(WS_URL);

      socket.onopen = () => {
        setConnectionState(true);
      };

      socket.onmessage = (event) => {
        const msg = JSON.parse(event.data);
        handleMessage(msg);
      };

      socket.onclose = () => {
        setConnectionState(false);
        setTimeout(connect, 2000);
      };
    }

    function handleMessage(msg) {
      if (!msg || !msg.type) return;

      switch (msg.type) {
        case "SYNC": {
          // msg.orders is an object keyed by orderId
          Object.keys(msg.orders || {}).forEach((id) => {
            const o = msg.orders[id];
            orders[id] = { ...o };
          });
          // pick a default selected order
          const ids = Object.keys(orders);
          selectedOrderId = ids.length ? ids[0] : null;
          render();
          break;
        }
        case "NEW_ORDER": {
          const id = msg.orderId;
          const existing = orders[id] || {};
          // Preserve local kitchen status if we already had one
          const status = existing.status || msg.status || "new";

          orders[id] = {
            ...msg,
            status,
          };

          // If nothing selected, focus this one
          if (!selectedOrderId) {
            selectedOrderId = id;
          }
          render();
          break;
        }
        default:
          break;
      }
    }

    // ---------- ORDER STATE & RENDERING ----------

    function cycleStatus(orderId) {
      const order = orders[orderId];
      if (!order) return;

      if (order.status === "new") {
        order.status = "in-progress";
      } else if (order.status === "in-progress") {
        order.status = "ready";

        // Play chime then queue TTS
        try {
          readySound.currentTime = 0;
          readySound.play().catch(() => {});
        } catch (e) {}

        enqueueAnnouncement(order.orderNumber);

        // Move to recently completed after 5s
        setTimeout(() => {
          if (!orders[orderId]) return;
          if (orders[orderId].status !== "ready") return;
          recentCompleted.unshift({
            orderNumber: orders[orderId].orderNumber,
          });
          if (recentCompleted.length > 10) recentCompleted.pop();
          delete orders[orderId];
          if (selectedOrderId === orderId) {
            const ids = Object.keys(orders);
            selectedOrderId = ids.length ? ids[0] : null;
          }
          render();
        }, 5000);
      }

      render();
    }

    function formatStatus(status) {
      if (status === "in-progress") return "IN PROGRESS";
      return status ? status.toUpperCase() : "--";
    }

    function render() {
      const activeList = Object.values(orders).sort(
        (a, b) => (a.createdAt || 0) - (b.createdAt || 0)
      );

      bubbleContainer.innerHTML = "";
      if (!activeList.length) {
        bubbleContainer.appendChild(emptyState);
      } else {
        if (emptyState.parentElement === bubbleContainer) {
          bubbleContainer.removeChild(emptyState);
        }

        activeList.forEach((o) => {
          const b = document.createElement("div");
          b.className = `bubble ${o.status || "new"}${
            o.orderId === selectedOrderId ? " selected" : ""
          }`;
          b.dataset.orderId = o.orderId;
          b.onclick = () => {
            if (selectedOrderId === o.orderId) {
              cycleStatus(o.orderId);
            } else {
              selectedOrderId = o.orderId;
              renderDetail();
            }
          };

          b.innerHTML = `
            <div class="bubble-number">#${o.orderNumber || "----"}</div>
            <div class="bubble-meta">
              ${o.itemCount || 0} item${(o.itemCount || 0) === 1 ? "" : "s"}
            </div>
            <div class="bubble-status">${formatStatus(o.status || "new")}</div>
          `;

          bubbleContainer.appendChild(b);
        });
      }

      renderDetail();
      renderRecent();
    }

    function renderDetail() {
      const order = orders[selectedOrderId];

      if (!order) {
        detailTitle.textContent = "No order selected";
        detailStatus.textContent = "--";
        detailStatus.className = "detail-status";
        detailMeta.innerHTML = `<span>Items: 0</span><span>Waiting...</span>`;
        itemsList.innerHTML = `
          <div style="font-size:0.8rem;color:var(--muted);margin-top:0.4rem;">
            Tap an order bubble to see item details here.
          </div>
        `;
        return;
      }

      detailTitle.textContent = `Order #${order.orderNumber || "----"}`;
      const st = order.status || "new";
      detailStatus.textContent = formatStatus(st);
      detailStatus.className = `detail-status ${st}`;

      const itemCount = order.itemCount || (order.items ? order.items.length : 0) || 0;
      const created = order.createdAt
        ? new Date(order.createdAt).toLocaleTimeString([], {
            hour: "numeric",
            minute: "2-digit",
          })
        : "";

      detailMeta.innerHTML = `
        <span>Items: ${itemCount}</span>
        ${created ? `<span>Created: ${created}</span>` : ""}
      `;

      itemsList.innerHTML = "";
      const items = Array.isArray(order.items) ? order.items : [];
      if (!items.length) {
        itemsList.innerHTML = `
          <div style="font-size:0.8rem;color:var(--muted);margin-top:0.4rem;">
            No item details.
          </div>
        `;
        return;
      }

      items.forEach((it) => {
        const row = document.createElement("div");
        row.className = "item-row";
        const mods =
          it.modifiers && it.modifiers.length
            ? `<div class="item-modifiers">${it.modifiers.join(", ")}</div>`
            : "";
        row.innerHTML = `
          <div class="item-main">
            <span class="item-name">${it.name || "Item"}</span>
            <span class="item-qty">×${it.quantity || 1}</span>
          </div>
          ${mods}
        `;
        itemsList.appendChild(row);
      });
    }

    function renderRecent() {
      recentContainer.innerHTML = "";
      if (!recentCompleted.length) return;
      recentCompleted.forEach((o) => {
        const pill = document.createElement("div");
        pill.className = "recent-pill";
        pill.textContent = `#${o.orderNumber}`;
        recentContainer.appendChild(pill);
      });
    }

    // Kick off
    connect();
  </script>
</body>
</html>
